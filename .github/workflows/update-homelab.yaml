name: Sync Bot Code to Homelab

on:
  # Trigger on push to main (direct commits)
  push:
    branches: [ main ]
  
  # Trigger when PR is merged
  pull_request:
    branches: [ main ]
    types: [closed]

jobs:
  sync:
    # For PR events, only run if PR was merged (not just closed)
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Determine trigger type
      id: trigger-info
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "Trigger: Direct push to main"
          echo "Commit: ${{ github.sha }}"
          echo "trigger_type=push" >> $GITHUB_OUTPUT
        else
          echo "Trigger: PR #${{ github.event.pull_request.number }} merged"
          echo "Merge commit: ${{ github.event.pull_request.merge_commit_sha }}"
          echo "Merged by: ${{ github.event.pull_request.merged_by.login }}"
          echo "trigger_type=pr_merge" >> $GITHUB_OUTPUT
        fi

    - name: Checkout ateluningning
      uses: actions/checkout@v4
      with:
        ref: main  # Always checkout main branch
        fetch-depth: 0

    - name: Checkout bakuran-homelab
      uses: actions/checkout@v4
      with:
        repository: fish-vendor-1731/bakuran-homelab
        token: ${{ secrets.HOMELAB_PAT }}
        ref: dev
        # No path parameter - checks out to current directory

    - name: Check for changes
      id: check-changes
      run: |
        echo "Checking for source code changes..."

        # Create target directory if it doesn't exist
        mkdir -p apps/discord-bot

        # List of specific bot source files to check
        BOT_FILES="main.go go.mod go.sum README.md .gitignore"

        CHANGED=false
        echo "Comparing bot source files..."

        # Check each bot file
        for file in $BOT_FILES; do
          if [ -f "$file" ]; then
            target_path="apps/discord-bot/$file"

            # Check if file exists in target
            if [ -f "$target_path" ]; then
              # Compare file contents
              if ! cmp -s "$file" "$target_path"; then
                echo "  üìù Changed: $file"
                CHANGED=true
              fi
            else
              echo "  ‚ûï New: $file"
              CHANGED=true
            fi
          fi
        done

        # Also check for any .go files in the root
        echo "Checking Go source files..."
        find . -maxdepth 1 -name "*.go" | while read -r file; do
          filename=$(basename "$file")
          if [ "$filename" != "main.go" ]; then  # main.go already checked
            target_path="apps/discord-bot/$filename"

            if [ -f "$target_path" ]; then
              if ! cmp -s "$file" "$target_path"; then
                echo "  üìù Changed: $filename"
                CHANGED=true
              fi
            else
              echo "  ‚ûï New: $filename"
              CHANGED=true
            fi
          fi
        done

        if [ "$CHANGED" = true ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Changes detected"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "‚úÖ No changes detected"
        fi

    - name: Copy files if changed
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        echo "Copying updated files to homelab..."

        # Ensure target directory exists
        mkdir -p apps/discord-bot

        # List of specific bot source files to copy (not entire directory structure)
        BOT_FILES="main.go go.mod go.sum README.md .gitignore"

        echo "=== Copying bot source files ==="
        for file in $BOT_FILES; do
          if [ -f "$file" ]; then
            echo "  üìã Copying: $file"
            cp "$file" "apps/discord-bot/$file"
          else
            echo "  ‚ö†Ô∏è  File not found: $file"
          fi
        done

        # Also copy any .go files in the root
        echo "=== Copying Go source files ==="
        find . -maxdepth 1 -name "*.go" | while read -r file; do
          filename=$(basename "$file")
          if [ "$filename" != "main.go" ]; then  # main.go already copied
            echo "  üìã Copying: $filename"
            cp "$file" "apps/discord-bot/$filename"
          fi
        done

    - name: Commit and push to homelab
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        echo "=== Preparing to commit changes ==="

        # Configure git
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"

        # Check git status before adding
        echo "=== Git status before adding ==="
        git status --short

        # Add all changes in discord-bot folder
        echo "=== Adding discord-bot files ==="
        git add apps/discord-bot/

        # Check if there are actual changes to commit
        echo "=== Checking for staged changes ==="
        if git diff --cached --quiet; then
          echo "‚ö†Ô∏è  No changes to commit (files might be identical)"
          exit 0
        fi

        echo "=== Changes to be committed ==="
        git diff --cached --name-status

        # Create commit message based on trigger type
        if [ "${{ steps.trigger-info.outputs.trigger_type }}" = "push" ]; then
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG="sync: update bot source code from ateluningning\n\nSource commit: ${COMMIT_SHA}\nAuto-synced via GitHub Actions"
        else
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          MERGE_COMMIT="${{ github.event.pull_request.merge_commit_sha }}"
          MERGED_BY="${{ github.event.pull_request.merged_by.login }}"

          COMMIT_MSG="sync: update bot from PR #${PR_NUMBER} - ${PR_TITLE}\n\nPR #${PR_NUMBER} merged by ${MERGED_BY}\nMerge commit: ${MERGE_COMMIT}\nAuto-synced via GitHub Actions"
        fi

        echo -e "\n=== Commit message ==="
        echo "$COMMIT_MSG"

        # Commit changes
        git commit -m "$COMMIT_MSG"

        echo -e "\n=== Pulling latest changes before push ==="
        # Try to pull first to avoid conflicts
        git pull origin dev --no-edit || echo "Pull failed or had conflicts, continuing with force push..."

        echo -e "\n=== Pushing to homelab dev branch ==="
        # Try normal push first, then force if needed
        if ! git push origin dev; then
          echo "Normal push failed, trying force push with lease..."
          git push origin dev --force-with-lease
        fi

        echo "‚úÖ Successfully synced changes to homelab!"
        echo "üì¶ The discord-bot-docker.yml workflow will now automatically:"
        echo "   1. Build new Docker image with timestamp tag"
        echo "   2. Update deployment.yaml with new image tag"
        echo "   3. Flux will detect change and update deployment"
        echo "   4. New Discord bot pod will be created"

    - name: No changes needed
      if: steps.check-changes.outputs.changes == 'false'
      run: |
        echo "‚úÖ No changes detected."
        if [ "${{ steps.trigger-info.outputs.trigger_type }}" = "push" ]; then
          echo "Source commit: ${{ github.sha }}"
        else
          echo "PR #${{ github.event.pull_request.number }} was merged but no source code changes were found."
        fi